{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<style>
    .dashboard-container { max-width: 1600px; margin: 0 auto; }
    
    .dashboard-header { 
        background: white;
        padding: 24px 32px;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        margin-bottom: 28px;
    }
    
    .dashboard-header h1 { 
        color: #1d1d1f;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 16px;
    }
    
    .tabs { 
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .tab { 
        background: #f5f5f7;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        color: #1d1d1f;
    }
    
    .tab.active { 
        background: #0071e3;
        color: white;
        box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
    }
    
    .tab:hover:not(.active) { 
        background: #e8e8ed;
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .card { 
        background: white;
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 28px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }
    
    .card h2 { 
        color: #1d1d1f;
        font-size: 1.4rem;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
    }
    
    .card-icon { 
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #0071e3 0%, #005bb5 100%);
        color: white;
    }
    
    .form-grid { 
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
    
    .form-group { margin-bottom: 16px; }
    
    .form-group label { 
        display: block;
        margin-bottom: 8px;
        color: #6e6e73;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .form-group input, .form-group select { 
        width: 100%;
        background: #f5f5f7;
        border: 1px solid #d2d2d7;
        border-radius: 10px;
        padding: 12px;
        color: #1d1d1f;
        font-size: 0.95rem;
        transition: all 0.2s;
    }
    
    .form-group input:focus, .form-group select:focus { 
        outline: none;
        border-color: #0071e3;
        background: white;
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }
    
    .btn { 
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.95rem;
    }
    
    .btn-primary { 
        background: #0071e3;
        color: white;
    }
    
    .btn-primary:hover { 
        background: #0077ed;
        box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
    }
    
    .btn-success { 
        background: #34c759;
        color: white;
    }
    
    .btn-success:hover { 
        background: #30d158;
        box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
    }
    
    .btn-danger { 
        background: #ff3b30;
        color: white;
        padding: 8px 16px;
        font-size: 0.85rem;
    }
    
    .btn-danger:hover { 
        background: #ff2d55;
    }
    
    table { 
        width: 100%;
        border-collapse: collapse;
    }
    
    thead { 
        background: #f5f5f7;
        border-radius: 10px;
    }
    
    th { 
        padding: 14px;
        text-align: left;
        font-size: 0.8rem;
        color: #6e6e73;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    td { 
        padding: 14px;
        border-bottom: 1px solid #f5f5f7;
        color: #1d1d1f;
    }
    
    tbody tr:hover { 
        background: #fafafa;
    }
    
    /* Calendar Styles */
    .calendar-controls { 
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        align-items: flex-end;
        flex-wrap: wrap;
    }
    
    .calendar-controls select { 
        background: #f5f5f7;
        border: 1px solid #d2d2d7;
        padding: 10px 14px;
        border-radius: 10px;
        color: #1d1d1f;
        font-size: 0.9rem;
    }
    
    .calendar-header { 
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .calendar-month { 
        font-size: 1.3rem;
        font-weight: 600;
        color: #1d1d1f;
    }
    
    .calendar-nav button { 
        background: #f5f5f7;
        border: none;
        color: #1d1d1f;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        cursor: pointer;
        margin: 0 4px;
        transition: all 0.2s;
    }
    
    .calendar-nav button:hover { 
        background: #0071e3;
        color: white;
    }
    
    .calendar-grid { 
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 16px;
    }
    
    .calendar-day-header { 
        text-align: center;
        font-size: 0.75rem;
        color: #6e6e73;
        text-transform: uppercase;
        padding: 12px 0;
        font-weight: 600;
    }
    
    .calendar-day { 
        aspect-ratio: 1;
        background: #f5f5f7;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        padding: 8px;
        font-size: 0.8rem;
        transition: all 0.2s;
        min-height: 80px;
    }
    
    .calendar-day:hover { 
        background: #e8e8ed;
        transform: translateY(-2px);
    }
    
    .calendar-day.other-month { 
        color: #c7c7cc;
    }
    
    .calendar-day.today { 
        background: linear-gradient(135deg, #0071e3 0%, #005bb5 100%);
        color: white;
    }
    
    .calendar-day-number { 
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .status-dots {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 2px;
        margin-top: 4px;
    }
    
    .status-dot { 
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }
    
    /* User Cards */
    .user-cards { 
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .user-card { 
        background: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);
        border-radius: 16px;
        padding: 24px;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .user-card:hover { 
        border-color: #0071e3;
        box-shadow: 0 8px 20px rgba(0, 113, 227, 0.15);
        transform: translateY(-4px);
    }
    
    .user-card-header { 
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .user-card h3 { 
        font-size: 1.2rem;
        color: #1d1d1f;
        font-weight: 600;
    }
    
    .user-card p { 
        color: #6e6e73;
        font-size: 0.9rem;
        margin: 4px 0;
    }
    
    .user-stats { 
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 16px;
    }
    
    .stat-item { 
        text-align: center;
        padding: 12px;
        background: white;
        border-radius: 10px;
    }
    
    .stat-value { 
        font-size: 1.5rem;
        font-weight: 700;
        color: #0071e3;
    }
    
    .stat-label { 
        font-size: 0.7rem;
        color: #6e6e73;
        text-transform: uppercase;
        margin-top: 4px;
    }
    
    .role-badge { 
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .role-admin { 
        background: #ff3b30;
        color: white;
    }
    
    .role-intern { 
        background: #34c759;
        color: white;
    }
    
    /* User Detail Modal */
    .modal { 
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        align-items: center;
        justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content { 
        background: white;
        border-radius: 20px;
        padding: 32px;
        max-width: 900px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header { 
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .modal-header h3 { 
        font-size: 1.6rem;
        color: #1d1d1f;
        font-weight: 600;
    }
    
    .modal-close { 
        background: #f5f5f7;
        border: none;
        color: #6e6e73;
        font-size: 1.8rem;
        cursor: pointer;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        transition: all 0.2s;
    }
    
    .modal-close:hover { 
        background: #ff3b30;
        color: white;
    }
    
    .user-legend { 
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
        padding: 16px;
        background: #f5f5f7;
        border-radius: 12px;
    }
    
    .user-badge-legend { 
        padding: 8px 16px;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 500;
        border: 2px solid;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .user-badge-legend:hover { 
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* Holiday Styles */
    .holiday-stats { 
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .stat-box { 
        padding: 20px;
        border-radius: 14px;
        color: white;
        text-align: center;
    }
    
    .holiday-item-admin {
        background: #ffffff;
        border-radius: 14px;
        padding: 20px 24px;
        border-left: 5px solid;
        transition: all 0.3s;
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 20px;
        margin-bottom: 12px;
    }
    
    .holiday-item-admin:hover {
        transform: translateX(6px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    
    .holiday-item-admin.general { border-color: #0071e3; }
    .holiday-item-admin.restricted { border-color: #ff9500; }
    .holiday-item-admin.special { border-color: #34c759; }
    .holiday-item-admin.saturday { border-color: #af52de; }
    
    .holiday-date-box {
        text-align: center;
        padding: 16px;
        background: #f5f5f7;
        border-radius: 12px;
        min-width: 100px;
    }
    
    .holiday-date-day {
        font-size: 2em;
        font-weight: 800;
        color: #1d1d1f;
        line-height: 1;
        margin-bottom: 4px;
    }
    
    .holiday-date-month {
        font-size: 0.85em;
        font-weight: 600;
        color: #86868b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .holiday-date-weekday {
        font-size: 0.75em;
        color: #86868b;
        margin-top: 4px;
    }
    
    .holiday-info {
        flex: 1;
    }
    
    .holiday-title {
        font-size: 1.1em;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
    }
    
    .holiday-meta {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .holiday-type-badge {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 0.75em;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .holiday-type-badge.general {
        background: #e8f4fd;
        color: #0071e3;
    }
    
    .holiday-type-badge.restricted {
        background: #fff3cd;
        color: #ff9500;
    }
    
    .holiday-type-badge.special {
        background: #d1f4e0;
        color: #34c759;
    }
    
    .holiday-type-badge.saturday {
        background: #f3e5f5;
        color: #af52de;
    }
    
    .holiday-icon {
        font-size: 2em;
        color: #86868b;
    }
    
    @media (max-width: 968px) { 
        .form-grid { grid-template-columns: 1fr; }
        .user-stats { grid-template-columns: 1fr; }
        .calendar-grid { grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { min-height: 60px; font-size: 0.7rem; }
        .holiday-stats { grid-template-columns: repeat(2, 1fr); }
        .holiday-item-admin { grid-template-columns: 1fr; gap: 12px; }
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Admin Dashboard</h1>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">Users</button>
            <button class="tab" onclick="switchTab('calendar')">Calendar View</button>
            <button class="tab" onclick="switchTab('overview')">Overview</button>
            <button class="tab" onclick="switchTab('holidays')">Holidays</button>
            <button class="tab" onclick="switchTab('export')">Export</button>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content active">
        <div class="card">
            <h2>
                <div class="card-icon"><i class="fas fa-user-plus"></i></div>
                Create New User
            </h2>
            <form method="POST" action="{{ url_for('admin_create_user') }}" class="form-grid">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" name="password" required>
                </div>
                <div class="form-group">
                    <label>Role:</label>
                    <select name="role">
                        <option value="intern">Intern</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i> Create User
                    </button>
                </div>
            </form>
        </div>

        <div class="card">
            <h2>
                <div class="card-icon"><i class="fas fa-users"></i></div>
                All Users ({{ users|length }})
            </h2>
            <div class="user-cards">
                {% for user in users %}
                <div class="user-card">
                    <div class="user-card-header">
                        <h3>{{ user.username }}</h3>
                        <span class="role-badge role-{{ user.role }}">{{ user.role }}</span>
                    </div>
                    <p><i class="fas fa-envelope"></i> {{ user.email or 'No email' }}</p>
                    <p><i class="fas fa-calendar"></i> Joined {{ user.created_at.strftime('%b %d, %Y') if user.created_at else 'N/A' }}</p>
                    
                    {% if user.role == 'intern' %}
                    <div class="user-stats" id="stats-{{ user._id }}">
                        <div class="stat-item">
                            <div class="stat-value">-</div>
                            <div class="stat-label">Working Days</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">-</div>
                            <div class="stat-label">This Month</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">-</div>
                            <div class="stat-label">Leaves</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div style="margin-top: 16px; display: flex; gap: 8px;">
                        {% if user.role == 'intern' %}
                        <button class="btn btn-primary" onclick="viewUserCalendar('{{ user._id }}', '{{ user.username }}')" style="flex: 1;">
                            <i class="fas fa-calendar-alt"></i> View Calendar
                        </button>
                        {% endif %}
                        <button class="btn btn-danger" onclick="deleteUser('{{ user._id }}', '{{ user.username }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Calendar Tab -->
    <div id="calendar" class="tab-content">
        <div class="card">
            <h2>
                <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
                Attendance Calendar
            </h2>
            
            <div class="calendar-controls">
                <div class="form-group" style="margin: 0; flex: 1; min-width: 200px;">
                    <label>Select Users:</label>
                    <select id="userFilter" multiple style="height: 100px;">
                        <option value="all" selected>All Users</option>
                        {% for user in users %}
                        {% if user.role == 'intern' %}
                        <option value="{{ user._id }}">{{ user.username }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div style="display: flex; gap: 8px; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="loadCalendarData()">
                        <i class="fas fa-sync"></i> Load Calendar
                    </button>
                    <button class="btn btn-success" onclick="selectAllUsers()">
                        <i class="fas fa-check-double"></i> Select All
                    </button>
                </div>
            </div>

            <div class="user-legend" id="userLegend"></div>

            <div class="calendar-header">
                <div class="calendar-month" id="calendarMonth">Loading...</div>
                <div class="calendar-nav">
                    <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content">
        <div class="card">
            <h2>
                <div class="card-icon"><i class="fas fa-history"></i></div>
                Recent Attendance
            </h2>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Date</th>
                        <th>Login</th>
                        <th>Logout</th>
                        <th>Hours</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in recent[:20] %}
                    <tr>
                        <td><strong>{{ rec.username }}</strong></td>
                        <td>{{ rec.date }}</td>
                        <td>{{ rec.login_time or 'N/A' }}</td>
                        <td>{{ rec.logout_time or 'N/A' }}</td>
                        <td><strong style="color: #0071e3;">{{ rec.hours or 'N/A' }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>
                <div class="card-icon"><i class="fas fa-calendar-times"></i></div>
                Recent Leaves
            </h2>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in leaves[:20] %}
                    <tr>
                        <td><strong>{{ leave.username }}</strong></td>
                        <td>{{ leave.date }}</td>
                        <td><span style="background: #ffd60a; color: #1d1d1f; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem;">{{ leave.type }}</span></td>
                        <td>{{ leave.comments or '‚Äî' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Holidays Tab -->
    <div id="holidays" class="tab-content">
        <div class="card">
            <h2>
                <div class="card-icon"><i class="fas fa-calendar-check"></i></div>
                University Holidays 2026
            </h2>
            
            <div class="holiday-stats">
                <div class="stat-box" style="background: linear-gradient(135deg, #0071e3 0%, #005bb5 100%);">
                    <div class="stat-label" style="color: rgba(255,255,255,0.8);">General Holidays</div>
                    <div class="stat-value" id="generalHolidayCount" style="color: white;">21</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);">
                    <div class="stat-label" style="color: rgba(255,255,255,0.8);">Restricted</div>
                    <div class="stat-value" id="restrictedHolidayCount" style="color: white;">1</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #34c759 0%, #30d158 100%);">
                    <div class="stat-label" style="color: rgba(255,255,255,0.8);">Special Holidays</div>
                    <div class="stat-value" id="specialHolidayCount" style="color: white;">8</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #af52de 0%, #9747ff 100%);">
                    <div class="stat-label" style="color: rgba(255,255,255,0.8);">Saturday Holidays</div>
                    <div class="stat-value" id="saturdayHolidayCount" style="color: white;">5</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #1d1d1f;">Filter by Month:</label>
                <select id="holidayMonthFilter" style="padding: 10px 14px; border-radius: 10px; border: 1px solid #d2d2d7; background: #f5f5f7; color: #1d1d1f; font-size: 0.9rem; cursor: pointer;">
                    <option value="all">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>

            <div id="holidayListAdmin" style="display: grid; gap: 12px;">
                <!-- Holiday items will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Export Tab -->
    <div id="export" class="tab-content">
        <div class="card">
            <h2>
                <div class="card-icon"><i class="fas fa-download"></i></div>
                Export Attendance
            </h2>
            <form method="GET" action="{{ url_for('admin_export') }}" class="form-grid">
                <div class="form-group">
                    <label>Start Date:</label>
                    <input type="date" name="start" required>
                </div>
                <div class="form-group">
                    <label>End Date:</label>
                    <input type="date" name="end" required>
                </div>
                <div style="grid-column: 1 / -1;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Details</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<script>
    let currentMonth = new Date();
    let calendarData = {};
    let selectedUserId = null;
    const userColors = ['#0071e3', '#34c759', '#ff3b30', '#ffd60a', '#ff9500', '#af52de', '#ff2d55', '#5ac8fa'];
    let userColorMap = {};
    let holidayDataAdmin = {};

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tab).classList.add('active');
        
        if (tab === 'users') {
            loadUserStats();
        } else if (tab === 'holidays') {
            loadAllHolidays();
        }
    }

    async function loadUserStats() {
        const users = {{ users | tojson | safe }};
        for (const user of users) {
            if (user.role === 'intern') {
                try {
                    const res = await fetch(`/api/admin/user-stats/${user._id}`);
                    const data = await res.json();
                    const statsDiv = document.getElementById(`stats-${user._id}`);
                    if (statsDiv && data) {
                        statsDiv.innerHTML = `
                            <div class="stat-item">
                                <div class="stat-value">${data.total_working_days || 0}</div>
                                <div class="stat-label">Working Days</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${data.attendance_this_month || 0}</div>
                                <div class="stat-label">This Month</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${data.leaves_this_month || 0}</div>
                                <div class="stat-label">Leaves</div>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.error('Error loading stats:', e);
                }
            }
        }
    }

    async function deleteUser(userId, username) {
        if (!confirm(`Are you sure you want to delete user "${username}"? This will also delete all their attendance and leave records.`)) {
            return;
        }
        
        try {
            const res = await fetch(`/admin/delete_user/${userId}`, { method: 'POST' });
            const data = await res.json();
            
            if (data.ok) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Error deleting user: ' + e.message);
        }
    }

    async function viewUserCalendar(userId, username) {
        selectedUserId = userId;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('calendar').classList.add('active');
        
        const select = document.getElementById('userFilter');
        for (let opt of select.options) {
            opt.selected = opt.value === userId;
        }
        
        await loadCalendarData();
        
        try {
            const res = await fetch(`/api/admin/user-stats/${userId}`);
            const stats = await res.json();
            
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = `${username}'s Statistics`;
            body.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 20px; background: #f5f5f7; border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: #0071e3;">${stats.total_working_days || 0}</div>
                        <div style="font-size: 0.8rem; color: #6e6e73; margin-top: 4px;">TOTAL WORKING DAYS</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f5f5f7; border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: #34c759;">${stats.attendance_this_month || 0}</div>
                        <div style="font-size: 0.8rem; color: #6e6e73; margin-top: 4px;">ATTENDANCE THIS MONTH</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f5f5f7; border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: #ff9500;">${stats.leaves_this_month || 0}</div>
                        <div style="font-size: 0.8rem; color: #6e6e73; margin-top: 4px;">LEAVES THIS MONTH</div>
                    </div>
                </div>
                <div style="text-align: center; color: #6e6e73; font-size: 0.9rem;">
                    <i class="fas fa-envelope"></i> ${stats.email || 'No email'}
                </div>
            `;
            
            modal.classList.add('active');
        } catch (e) {
            console.error('Error loading user stats:', e);
        }
    }

    function selectAllUsers() {
        const select = document.getElementById('userFilter');
        for (let opt of select.options) {
            opt.selected = true;
        }
    }

    async function loadCalendarData() {
        const select = document.getElementById('userFilter');
        const selected = Array.from(select.selectedOptions).map(o => o.value);
        
        if (selected.length === 0) {
            alert('Please select at least one user');
            return;
        }

        const params = new URLSearchParams();
        selected.forEach(u => params.append('users', u));
        
        const start = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
        const end = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
        params.append('start_date', start.toISOString().split('T')[0]);
        params.append('end_date', end.toISOString().split('T')[0]);

        try {
            const res = await fetch(`/api/admin/calendar-data?${params}`);
            const data = await res.json();
            calendarData = data.calendar_data;
            
            // Load holidays for the month
            await loadAdminMonthHolidays();
            
            renderUserLegend();
            renderCalendar();
        } catch (e) {
            console.error('Error loading calendar data:', e);
            alert('Failed to load calendar data');
        }
    }

    async function loadAdminMonthHolidays() {
        try {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            const res = await fetch(`/api/holidays?year=2026&month=${month}`);
            const data = await res.json();
            
            // Store holiday data
            holidayDataAdmin = data.holidays;
        } catch (e) {
            console.error('Error loading admin holidays:', e);
        }
    }

    function renderUserLegend() {
        const usernames = Object.keys(calendarData);
        const legend = document.getElementById('userLegend');
        
        userColorMap = {};
        usernames.forEach((username, i) => {
            userColorMap[username] = userColors[i % userColors.length];
        });
        
        legend.innerHTML = usernames.map((username, i) => {
            const color = userColors[i % userColors.length];
            return `
                <div class="user-badge-legend" style="background: ${color}; color: white; border-color: ${color};">
                    ${username}
                </div>
            `;
        }).join('');
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthEl = document.getElementById('calendarMonth');
        
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        
        monthEl.textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startingDayOfWeek = firstDay.getDay();
        
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        
        grid.innerHTML = '';
        
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = day;
            grid.appendChild(header);
        });
        
        for (let i = startingDayOfWeek - 1; i >= 0; i--) {
            const dayEl = createCalendarDay(prevMonthLastDay - i, true);
            grid.appendChild(dayEl);
        }
        
        const today = new Date();
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
            const dayEl = createCalendarDay(day, false, isToday);
            grid.appendChild(dayEl);
        }
        
        const remainingCells = 42 - grid.children.length + 7;
        for (let i = 1; i <= remainingCells; i++) {
            const dayEl = createCalendarDay(i, true);
            grid.appendChild(dayEl);
        }
    }

    function createCalendarDay(dayNum, otherMonth, isToday = false) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        if (otherMonth) dayEl.classList.add('other-month');
        if (isToday) dayEl.classList.add('today');
        
        const dateStr = !otherMonth 
            ? `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`
            : null;
        
        dayEl.innerHTML = `<div class="calendar-day-number">${dayNum}</div>`;
        
        if (!otherMonth && dateStr) {
            const dotsContainer = document.createElement('div');
            dotsContainer.className = 'status-dots';
            
            // Check if it's a holiday
            if (holidayDataAdmin[dateStr]) {
                const holidayBadge = document.createElement('div');
                holidayBadge.style.cssText = 'background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-top: 2px;';
                holidayBadge.textContent = 'üéâ';
                dayEl.appendChild(holidayBadge);
            }
            
            Object.keys(calendarData).forEach(username => {
                if (calendarData[username][dateStr]) {
                    const entry = calendarData[username][dateStr];
                    const dot = document.createElement('div');
                    dot.className = 'status-dot';
                    
                    if (entry.type === 'present') {
                        dot.style.background = userColorMap[username];
                    } else if (entry.type === 'leave') {
                        dot.style.background = '#ff9500';
                    }
                    
                    dotsContainer.appendChild(dot);
                }
            });
            
            if (dotsContainer.children.length > 0) {
                dayEl.appendChild(dotsContainer);
            }
            
            dayEl.onclick = () => showDayDetails(dateStr);
        }
        
        return dayEl;
    }

    function showDayDetails(dateStr) {
        const modal = document.getElementById('detailModal');
        const title = document.getElementById('modalTitle');
        const body = document.getElementById('modalBody');
        
        title.textContent = `Details for ${dateStr}`;
        
        let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';
        
        // Check if it's a holiday
        if (holidayDataAdmin[dateStr]) {
            const holiday = holidayDataAdmin[dateStr];
            const dateObj = new Date(dateStr);
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            
            html += `
                <div style="padding: 20px; background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%); border-radius: 12px; color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 2em;">üéâ</div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 700;">${holiday.name}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">${dayName}, ${dateStr}</div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; display: inline-block; font-size: 0.8rem; font-weight: 600;">
                        ${holiday.type.toUpperCase()} HOLIDAY
                    </div>
                </div>
            `;
        }
        
        Object.keys(calendarData).forEach(username => {
            if (calendarData[username][dateStr]) {
                const entry = calendarData[username][dateStr];
                const color = userColorMap[username];
                
                if (entry.type === 'present') {
                    html += `
                        <div style="padding: 16px; background: #f5f5f7; border-radius: 12px; border-left: 4px solid ${color};">
                            <div style="font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">${username}</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 0.9rem; color: #6e6e73;">
                                <div>
                                    <div style="font-size: 0.75rem; text-transform: uppercase; margin-bottom: 4px;">Login</div>
                                    <div style="color: #1d1d1f; font-weight: 500;">${entry.login_time}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; text-transform: uppercase; margin-bottom: 4px;">Logout</div>
                                    <div style="color: #1d1d1f; font-weight: 500;">${entry.logout_time}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; text-transform: uppercase; margin-bottom: 4px;">Hours</div>
                                    <div style="color: #0071e3; font-weight: 700;">${entry.hours}h</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (entry.type === 'leave') {
                    html += `
                        <div style="padding: 16px; background: #fff9e6; border-radius: 12px; border-left: 4px solid #ff9500;">
                            <div style="font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">${username}</div>
                            <div style="font-size: 0.9rem; color: #6e6e73;">
                                <div style="margin-bottom: 4px;"><strong>Leave Type:</strong> ${entry.leave_type}</div>
                                ${entry.comments ? `<div><strong>Comments:</strong> ${entry.comments}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
        });
        
        html += '</div>';
        body.innerHTML = html || '<p style="text-align: center; color: #6e6e73;">No records for this day</p>';
        
        modal.classList.add('active');
    }

    function changeMonth(delta) {
        currentMonth.setMonth(currentMonth.getMonth() + delta);
        loadCalendarData();
    }

    function closeModal() {
        document.getElementById('detailModal').classList.remove('active');
    }

    // Holidays functions
    async function loadAllHolidays() {
        try {
            const res = await fetch('/api/holidays');
            const data = await res.json();
            
            const holidays = Object.entries(data.holidays).map(([date, info]) => ({
                date: date,
                ...info
            })).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Count by type
            const counts = {
                general: holidays.filter(h => h.type === 'general').length,
                restricted: holidays.filter(h => h.type === 'restricted').length,
                special: holidays.filter(h => h.type === 'special').length,
                saturday: holidays.filter(h => h.type === 'saturday').length
            };
            
            document.getElementById('generalHolidayCount').textContent = counts.general;
            document.getElementById('restrictedHolidayCount').textContent = counts.restricted;
            document.getElementById('specialHolidayCount').textContent = counts.special;
            document.getElementById('saturdayHolidayCount').textContent = counts.saturday;
            
            renderHolidayList(holidays);
            
            // Add month filter listener
            document.getElementById('holidayMonthFilter').addEventListener('change', function() {
                filterHolidays(holidays, this.value);
            });
            
        } catch (e) {
            console.error('Error loading holidays:', e);
            document.getElementById('holidayListAdmin').innerHTML = '<div style="text-align: center; padding: 40px; color: #ff3b30;">Failed to load holidays</div>';
        }
    }

    function renderHolidayList(holidays) {
        const container = document.getElementById('holidayListAdmin');
        
        if (holidays.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #86868b;">No holidays found</div>';
            return;
        }
        
        container.innerHTML = holidays.map(holiday => {
            const date = new Date(holiday.date);
            const day = date.getDate();
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            const weekday = date.toLocaleDateString('en-US', { weekday: 'short' });
            
            const icons = {
                general: 'üéâ',
                restricted: '‚≠ê',
                special: 'üéä',
                saturday: 'üìÖ'
            };
            
            return `
                <div class="holiday-item-admin ${holiday.type}">
                    <div class="holiday-date-box">
                        <div class="holiday-date-day">${day}</div>
                        <div class="holiday-date-month">${month}</div>
                        <div class="holiday-date-weekday">${weekday}</div>
                    </div>
                    <div class="holiday-info">
                        <div class="holiday-title">${holiday.name}</div>
                        <div class="holiday-meta">
                            <span class="holiday-type-badge ${holiday.type}">${holiday.type}</span>
                            <span style="font-size: 0.85em; color: #86868b;">${holiday.date}</span>
                        </div>
                    </div>
                    <div class="holiday-icon">${icons[holiday.type] || 'üìÖ'}</div>
                </div>
            `;
        }).join('');
    }

    function filterHolidays(allHolidays, monthFilter) {
        if (monthFilter === 'all') {
            renderHolidayList(allHolidays);
            return;
        }
        
        const filtered = allHolidays.filter(holiday => {
            const date = new Date(holiday.date);
            return date.getMonth() + 1 === parseInt(monthFilter);
        });
        
        renderHolidayList(filtered);
    }

    // Event listeners
    document.getElementById('detailModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        loadUserStats();
    });
</script>

{% endblock %}