{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #0f0f23; color: #e0e0e0; padding: 16px; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; }
        .dashboard-header { background: #1a1a2e; padding: 16px 24px; border-radius: 12px; border: 1px solid #2a2a3e; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-header h1 { color: #fff; font-size: 1.4em; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        .time-info { font-size: 0.8em; color: #a0a0a0; text-align: right; }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: #1a1a2e; border: 1px solid #2a2a3e; border-radius: 12px; padding: 20px; }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        .card-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1em; background: rgba(102, 126, 234, 0.1); color: #667eea; }
        .card-header h2 { font-size: 1.05em; color: #fff; font-weight: 600; }

        .attendance-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .action-box { background: #0f0f23; border: 1px solid #2a2a3e; border-radius: 8px; padding: 16px; }
        .action-label { font-size: 0.7em; color: #808080; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .status-badge { padding: 3px 10px; border-radius: 4px; font-size: 0.75em; font-weight: 600; }
        .status-active { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-inactive { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .time-display { font-size: 1.3em; color: #fff; font-weight: 600; margin-bottom: 10px; }
        .btn { width: 100%; padding: 9px; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-login { background: #22c55e; color: white; }
        .btn-logout { background: #ef4444; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
        .stat-box { background: #0f0f23; border: 1px solid #2a2a3e; border-radius: 8px; padding: 12px; text-align: center; }
        .stat-label { font-size: 0.7em; color: #808080; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .stat-value { font-size: 1.5em; color: #fff; font-weight: 700; }
        .stat-unit { font-size: 0.45em; color: #a0a0a0; }

        .calendar-container { font-size: 0.75em; padding: 12px; }
        .calendar-grid { gap: 3px; font-size: 0.78em; display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { aspect-ratio: 1; font-size: 0.75em; padding: 2px; position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .calendar-day-header { font-size: 0.65em; color: #808080; text-transform: uppercase; padding: 6px 0; text-align: center; }
        .calendar-day.other-month { color: #4a4a5e; }
        .calendar-day.today { border: 1px solid #667eea; color: #667eea; }
        .calendar-day.present { background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; color: #22c55e; }
        .calendar-day.absent { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; color: #ef4444; }
        .calendar-day.leave { background: rgba(234, 179, 8, 0.2); border: 1px solid #eab308; color: #eab308; }

        .calendar-day.leave::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1a1a2e; color: #fff; padding: 6px 10px; border-radius: 6px;
            font-size: 0.7em; white-space: nowrap; opacity: 0; pointer-events: none;
            transition: opacity 0.2s; z-index: 10; border: 1px solid #2a2a3e;
        }
        .calendar-day.leave:hover::after { opacity: 1; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1a1a2e; border: 1px solid #2a2a3e; border-radius: 12px; padding: 24px; max-width: 420px; width: 90%; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: #a0a0a0; font-size: 0.85em; }
        .form-group select, .form-group textarea { width: 100%; background: #0f0f23; border: 1px solid #2a2a3e; border-radius: 6px; padding: 10px; color: #e0e0e0; }
        .btn-primary { background: #667eea; color: white; padding: 10px; width: 100%; border-radius: 6px; }

        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
        .alert-success { background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; color: #22c55e; }
        .alert-danger { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; color: #ef4444; }

        .loading { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 968px) { .main-grid, .attendance-actions, .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Welcome, <span id="username">Loading...</span></h1>
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div class="time-info">
                    <div id="currentDate"></div>
                    <div id="currentTime"></div>
                    <div style="font-size: 0.85em; color: #667eea;">IST</div>
                </div>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="main-grid">
            <!-- Today's Attendance -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-clock"></i></div>
                    <h2>Today's Attendance</h2>
                </div>
                <div class="attendance-actions">
                    <div class="action-box">
                        <div class="action-label">Login</div>
                        <div class="status-badge status-inactive" id="loginStatus">Not Logged In</div>
                        <div class="time-display" id="loginTime">--:--</div>
                        <button id="loginBtn" class="btn btn-login">Login</button>
                    </div>
                    <div class="action-box">
                        <div class="action-label">Logout</div>
                        <div class="status-badge status-inactive" id="logoutStatus">Not Logged Out</div>
                        <div class="time-display" id="logoutTime">--:--</div>
                        <button id="logoutBtn" class="btn btn-logout" disabled>Logout</button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                    <h2>Statistics</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Today</div>
                        <div class="stat-value" id="hoursWorked">0.0<span class="stat-unit">hrs</span></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Week</div>
                        <div class="stat-value" id="weekHours">0.0<span class="stat-unit">hrs</span></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Month</div>
                        <div class="stat-value" id="monthHours">0.0<span class="stat-unit">hrs</span></div>
                    </div>
                </div>
                <div class="stat-box" style="margin-top:12px;">
                    <div class="stat-label">Last 90 Days</div>
                    <div class="stat-value" id="totalHours">0.0<span class="stat-unit">hrs</span></div>
                </div>
            </div>

            <!-- Calendar -->
            <div class="card calendar-container">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
                    <h2>Attendance Calendar</h2>
                </div>
                <div class="calendar-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div class="calendar-month" id="calendarMonth">Loading...</div>
                    <div class="calendar-nav">
                        <button id="prevMonth" style="background:#0f0f23;border:1px solid #2a2a3e;color:#e0e0e0;width:28px;height:28px;border-radius:6px;cursor:pointer;">◀</button>
                        <button id="nextMonth" style="background:#0f0f23;border:1px solid #2a2a3e;color:#e0e0e0;width:28px;height:28px;border-radius:6px;cursor:pointer;">▶</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <!-- History -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-history"></i></div>
                    <h2>Recent History</h2>
                </div>
                <table style="width:100%; border-collapse:collapse;">
                    <thead style="background:#0f0f23;">
                        <tr>
                            <th style="padding:10px 8px; font-size:0.8em; color:#808080; text-align:left;">Date</th>
                            <th style="padding:10px 8px; font-size:0.8em; color:#808080; text-align:left;">Login (IST)</th>
                            <th style="padding:10px 8px; font-size:0.8em; color:#808080; text-align:left;">Logout (IST)</th>
                            <th style="padding:10px 8px; font-size:0.8em; color:#808080; text-align:left;">Hours</th>
                            <th style="padding:10px 8px; font-size:0.8em; color:#808080; text-align:left;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr><td colspan="5" style="text-align:center; padding:20px; color:#808080;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Leave Modal -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3>Add Leave</h3>
                <button class="modal-close" onclick="closeLeaveModal()" style="background:none; border:none; color:#808080; font-size:1.5em; cursor:pointer;">×</button>
            </div>
            <form id="leaveForm">
                <input type="hidden" id="leaveDate">
                <div class="form-group">
                    <label>Leave Type</label>
                    <select id="leaveType" required>
                        <option value="">Select</option>
                        <option value="vacation">Vacation</option>
                        <option value="sick">Sick Leave</option>
                        <option value="personal">Personal</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Comments (Optional)</label>
                    <textarea id="leaveComments" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Save Leave</button>
            </form>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let currentMonth = new Date();
        let attendanceData = {};
        let leaveData = {};
        let historyRecords = [];

        // Update current time in IST
        function updateTime() {
            const now = new Date();
            // Display in IST format
            const options = { 
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            };
            const timeOptions = { 
                timeZone: 'Asia/Kolkata',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-IN', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-IN', timeOptions);
        }
        setInterval(updateTime, 1000); 
        updateTime();

        function showAlert(msg, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${msg}`;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }

        function getLocation(cb) {
            if (!navigator.geolocation) return cb("Geolocation not supported");
            navigator.geolocation.getCurrentPosition(
                pos => cb(null, pos.coords.latitude, pos.coords.longitude),
                err => cb(err.message)
            );
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        document.getElementById('loginBtn').onclick = () => {
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Logging in...';
            getLocation((err, lat, lng) => {
                if (err) { showAlert(err, 'danger'); btn.disabled = false; btn.innerHTML = 'Login'; return; }
                if (!dashboardData) { showAlert('Data not loaded', 'danger'); btn.disabled = false; btn.innerHTML = 'Login'; return; }

                const dist = haversine(lat, lng, dashboardData.office_lat, dashboardData.office_lng);
                if (dist > dashboardData.allowed_radius_km) {
                    showAlert(`Too far: ${dist.toFixed(2)}km from office`, 'danger');
                    btn.disabled = false; btn.innerHTML = 'Login'; return;
                }

                fetch('/attendance/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat, lng })
                })
                .then(r => r.json())
                .then(d => {
                    if (d.ok) {
                        showAlert('Login successful! (IST: ' + d.login_time + ')', 'success');
                        loadDashboardData();
                    } else {
                        showAlert(d.error || 'Login failed', 'danger');
                    }
                })
                .catch(() => showAlert('Network error', 'danger'))
                .finally(() => { btn.disabled = false; btn.innerHTML = 'Login'; });
            });
        };

        document.getElementById('logoutBtn').onclick = () => {
            const btn = document.getElementById('logoutBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Logging out...';
            getLocation((err, lat, lng) => {
                fetch('/attendance/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: lat||null, lng: lng||null })
                })
                .then(r => r.json())
                .then(d => {
                    if (d.ok) {
                        showAlert(`Logged out! Worked ${d.hours} hrs (IST: ${d.logout_time})`, 'success');
                        loadDashboardData();
                    } else {
                        showAlert(d.error || 'Logout failed', 'danger');
                    }
                })
                .finally(() => { btn.innerHTML = 'Logout'; });
            });
        };

        function loadDashboardData() {
            fetch('/api/dashboard-data')
                .then(r => r.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    dashboardData = data;
                    updateUI(data);
                    loadLeaves();
                })
                .catch(err => showAlert('Failed to load data: ' + err.message, 'danger'));
        }

        function updateUI(data) {
            document.getElementById('username').textContent = data.username;
            document.getElementById('userAvatar').textContent = data.username[0].toUpperCase();

            const today = data.today_record || {};
            document.getElementById('loginTime').textContent = today.login_time || '--:--';
            document.getElementById('logoutTime').textContent = today.logout_time || '--:--';
            document.getElementById('hoursWorked').innerHTML = (today.hours || '0.0') + '<span class="stat-unit">hrs</span>';
            document.getElementById('totalHours').innerHTML = data.total_hours + '<span class="stat-unit">hrs</span>';

            const loginStatus = document.getElementById('loginStatus');
            const logoutStatus = document.getElementById('logoutStatus');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (today.login_time) {
                loginStatus.textContent = 'Logged In'; loginStatus.className = 'status-badge status-active';
                loginBtn.disabled = true; logoutBtn.disabled = false;
            }
            if (today.logout_time) {
                logoutStatus.textContent = 'Logged Out'; logoutStatus.className = 'status-badge status-active';
                logoutBtn.disabled = true;
            }

            attendanceData = {};
            historyRecords = data.history || [];
            data.history.forEach(r => attendanceData[r.date] = r);

            calculateStats();
            renderCalendar();
            renderHistory();
        }

        function calculateStats() {
            const now = new Date();
            const weekStart = new Date(now); weekStart.setDate(now.getDate() - now.getDay());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            let week = 0, month = 0;
            Object.values(attendanceData).forEach(r => {
                const d = new Date(r.date);
                const h = parseFloat(r.hours) || 0;
                if (d >= weekStart) week += h;
                if (d >= monthStart) month += h;
            });
            document.getElementById('weekHours').innerHTML = week.toFixed(1) + '<span class="stat-unit">hrs</span>';
            document.getElementById('monthHours').innerHTML = month.toFixed(1) + '<span class="stat-unit">hrs</span>';
        }

        function renderCalendar() {
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            document.getElementById('calendarMonth').textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
            const startWeek = first.getDay(), total = last.getDate();
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';

            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
                const h = document.createElement('div'); h.className = 'calendar-day-header'; h.textContent = d; grid.appendChild(h);
            });

            for (let i = startWeek - 1; i >= 0; i--) {
                const day = document.createElement('div'); day.className = 'calendar-day other-month';
                day.textContent = new Date(y, m, 0).getDate() - i; grid.appendChild(day);
            }

            const today = new Date();
            for (let d = 1; d <= total; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const day = document.createElement('div'); day.className = 'calendar-day'; day.textContent = d;

                if (d === today.getDate() && m === today.getMonth() && y === today.getFullYear()) day.classList.add('today');
                if (leaveData[dateStr]) {
                    day.classList.add('leave');
                    day.setAttribute('data-tooltip', `${leaveData[dateStr].type}: ${leaveData[dateStr].comments || '—'}`);
                } else if (attendanceData[dateStr]?.login_time) {
                    day.classList.add('present');
                } else if (new Date(y,m,d) < today && [1,2,3,4,5].includes(new Date(y,m,d).getDay())) {
                    day.classList.add('absent');
                }

                day.onclick = () => openLeaveModal(dateStr);
                grid.appendChild(day);
            }
        }

        document.getElementById('prevMonth').onclick = () => { currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); };
        document.getElementById('nextMonth').onclick = () => { currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); };

        function openLeaveModal(date) {
            document.getElementById('leaveDate').value = date;
            const leave = leaveData[date] || {};
            document.getElementById('leaveType').value = leave.type || '';
            document.getElementById('leaveComments').value = leave.comments || '';

            const saveBtn = document.querySelector('#leaveForm button');
            if (leave.type) {
                document.getElementById('leaveType').disabled = true;
                document.getElementById('leaveComments').readOnly = true;
                saveBtn.textContent = 'Already Saved';
                saveBtn.disabled = true;
            } else {
                document.getElementById('leaveType').disabled = false;
                document.getElementById('leaveComments').readOnly = false;
                saveBtn.textContent = 'Save Leave';
                saveBtn.disabled = false;
            }

            document.getElementById('leaveModal').classList.add('active');
        }

        window.closeLeaveModal = () => document.getElementById('leaveModal').classList.remove('active');
        document.getElementById('leaveModal').onclick = e => { if (e.target.id === 'leaveModal') closeLeaveModal(); };

        document.getElementById('leaveForm').onsubmit = async e => {
            e.preventDefault();
            const date = document.getElementById('leaveDate').value;
            const type = document.getElementById('leaveType').value;
            const comments = document.getElementById('leaveComments').value;

            const res = await fetch('/api/leave', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, type, comments })
            });
            const data = await res.json();
            if (data.ok) {
                showAlert('Leave saved!', 'success');
                leaveData[date] = { type, comments };
                renderCalendar();
                closeLeaveModal();
            } else {
                showAlert(data.error || 'Failed to save', 'danger');
            }
        };

        async function loadLeaves() {
            const res = await fetch('/api/leaves');
            leaveData = await res.json();
            renderCalendar();
        }

        function renderHistory() {
            const tbody = document.getElementById('historyTableBody');
            const recent = historyRecords.slice(0, 30);
            tbody.innerHTML = recent.map(r => {
                const leave = leaveData[r.date];
                const status = leave ? leave.type : (r.login_time !== 'N/A' ? 'Present' : 'Absent');
                const cls = leave ? 'status-badge' : (r.login_time !== 'N/A' ? 'status-active' : 'status-inactive');
                return `<tr>
                    <td style="padding:10px 8px; font-size:0.85em;">${r.date}</td>
                    <td style="padding:10px 8px; font-size:0.85em;">${r.login_time}</td>
                    <td style="padding:10px 8px; font-size:0.85em;">${r.logout_time}</td>
                    <td style="padding:10px 8px; font-size:0.85em;"><strong>${r.hours}</strong></td>
                    <td style="padding:10px 8px;"><span class="status-badge ${cls}">${status}</span></td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" style="text-align:center; color:#808080; padding:20px;">No records</td></tr>';
        }

        loadDashboardData();
    </script>
</body>
</html>
{% endblock %}